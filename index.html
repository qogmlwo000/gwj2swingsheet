<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GWJ2 OB 인원 관리 시트</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* (CSS는 이전과 동일) */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap');
        :root[color-theme='light']{--bg-primary:linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);--surface-primary:rgba(255, 255, 255, 0.8);--surface-secondary:rgba(255, 255, 255, 0.6);--text-primary:#1e293b;--text-secondary:#64748b;--accent:#3b82f6;--accent-hover:#2563eb;--border:rgba(148, 163, 184, 0.2);--shadow:0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);--shadow-lg:0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)}
        :root[color-theme='dark']{--bg-primary:linear-gradient(135deg, #0f172a 0%, #1e293b 100%);--surface-primary:rgba(30, 41, 59, 0.8);--surface-secondary:rgba(30, 41, 59, 0.6);--text-primary:#f1f5f9;--text-secondary:#94a3b8;--accent:#60a5fa;--accent-hover:#3b82f6;--border:rgba(148, 163, 184, 0.1);--shadow:0 1px 3px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(0, 0, 0, 0.12);--shadow-lg:0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Noto Sans KR', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;font-size:14px;line-height:1.5;transition:all 0.3s ease;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
        .fixed-header{position:fixed;top:16px;left:16px;right:16px;background:var(--surface-primary);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow-lg);z-index:1000;transition:all 0.3s ease}
        .fixed-header:hover{transform:translateY(-1px);box-shadow:0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)}
        .header-top{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--border)}
        .header-title{font-size:20px;font-weight:700;display:flex;align-items:center;gap:10px;letter-spacing:-0.025em;position:relative;overflow:visible}
        .title-text{position:relative;background:linear-gradient(45deg, #667eea, #764ba2, #f093fb, #f5576c, #4facfe, #00f2fe);background-size:400% 400%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:smooth-gradient-flow 8s ease-in-out infinite, subtle-glow 4s ease-in-out infinite;filter:brightness(1.1)}
        .title-text::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:radial-gradient(circle at center, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 30%, transparent 70%);opacity:0;animation:ethereal-glow 8s ease-in-out infinite;pointer-events:none}
        .date-display{display:inline-flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;color:#ffffff;background-color:#ef4444;border:1px solid #dc2626;border-radius:12px;padding:6px 10px;margin-left:12px;vertical-align:middle;box-shadow:0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);animation:fadeIn 0.8s ease-out forwards;white-space:nowrap;letter-spacing:-0.01em}
        .capture-btn{background:var(--surface-secondary);border:1px solid var(--border);border-radius:8px;padding:4px 8px;cursor:pointer;font-size:16px;line-height:1;transition:all 0.2s ease}
        .capture-btn:hover{background:var(--accent);color:white;border-color:var(--accent)}
        #user-status button{background:var(--accent);color:white;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;transition:background .2s ease}
        #user-status button:hover{background:var(--accent-hover)}
        #user-status span{margin-right:12px;font-weight:600}
        .rocket{font-size:24px;animation:rocket-thruster 2s ease-in-out infinite;filter:drop-shadow(0 0 8px rgba(255, 215, 0, 0.6))}
        .header-controls{display:flex;align-items:center;gap:16px}
        .clock-display{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--surface-primary);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);transition:all .2s ease}
        .clock-display:hover{transform:translateY(-1px);box-shadow:var(--shadow-lg)}
        .clock-emoji{font-size:18px;opacity:.8;margin-right:4px}
        .time-segment{display:flex;align-items:center;gap:4px}
        .time-unit{display:flex;align-items:center;gap:2px}
        .digit-box{display:flex;align-items:center;justify-content:center;width:28px;height:32px;background:var(--surface-secondary);border:1px solid var(--border);border-radius:8px;font-family:'Noto Sans KR', monospace;font-size:16px;font-weight:700;color:var(--text-primary);box-shadow:inset 0 1px 2px rgba(0, 0, 0, 0.05);transition:all .2s ease}
        .time-separator{font-size:18px;font-weight:600;color:var(--text-secondary);margin:0 2px;animation:blink 2s infinite}
        .clock-urgent .digit-box{background:rgba(239, 68, 68, 0.1) !important;border-color:#ef4444 !important;color:#ef4444 !important}
        .clock-urgent .time-separator{color:#ef4444 !important}
        .clock-urgent{animation:urgent-pulse 1.5s ease-in-out infinite}
        .dark-light-toggle{display:flex;justify-content:center;align-items:center;position:relative;width:48px;height:48px;background:var(--surface-secondary);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .2s ease;overflow:hidden}
        .dark-light-toggle:hover{transform:translateY(-1px);background:var(--surface-primary);border-color:var(--border)}
        .icon30{display:flex;justify-content:center;align-items:center;width:24px;height:24px;position:absolute}
        .icon30>svg{transition:all .3s ease}
        .sun{animation:rise-animation .6s ease-out forwards;transform-origin:center}
        .moon{animation:set-animation .6s ease-out forwards;transform-origin:center}
        [color-theme='dark'] .dark-light-toggle .sun{animation:set-animation .6s ease-out forwards}
        [color-theme='dark'] .dark-light-toggle .moon{animation:rise-animation .6s ease-out forwards}
        .dark-light-toggle:hover svg{fill:#f59e0b;transform:scale(1.1)}
        .tab-navigation{padding:16px 24px;background:transparent;border-bottom-left-radius:16px;border-bottom-right-radius:16px}
        .tab-list{display:flex;align-items:center;gap:32px;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;padding:4px 0}
        .tab-list::-webkit-scrollbar{display:none}
        .tab-item{position:relative;padding:12px 4px;background:transparent;border:none;color:var(--text-secondary);font-size:14px;font-weight:500;cursor:pointer;transition:all .3s ease;white-space:nowrap;user-select:none;flex-shrink:0}
        .tab-item::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:var(--accent);transform:scaleX(0);transition:transform .3s ease;border-radius:1px}
        .tab-item:hover{color:var(--text-primary)}
        .tab-item.active{color:var(--accent);font-weight:600}
        .tab-item.active::after{transform:scaleX(1)}
        .main-content{margin-top:140px;padding:24px;min-height:calc(100vh - 140px)}
        .content-area{background:var(--surface-primary);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid var(--border);border-radius:20px;padding:32px;box-shadow:var(--shadow-lg);transition:all .3s ease}
        .content-area:hover{transform:translateY(-2px);box-shadow:0 25px 50px -12px rgba(0, 0, 0, 0.15)}
        .welcome-message{text-align:center;color:var(--text-secondary);font-size:16px;font-weight:500;margin-top:40px;line-height:1.6;letter-spacing:-0.025em}
        .welcome-message strong{color:var(--text-primary);font-weight:600}
        .welcome-title{animation:fadeInUp .8s ease-out;letter-spacing:-.5px}
        .welcome-title-gradient{background:linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%);background-size:200% 200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:gradientFlow 8s ease infinite}
        .welcome-subtitle{animation:fadeInUp .8s ease-out .2s backwards}
        .welcome-line{animation:fadeInUp .8s ease-out .4s backwards;box-shadow:0 0 10px rgba(59, 130, 246, 0.3)}
        .welcome-version{animation:fadeInUp .8s ease-out .6s backwards;opacity:.5;transition:opacity .3s ease}
        .welcome-version:hover{opacity:1}
        .staffing-input{width:70px;text-align:center;background:var(--surface-secondary);border:2px solid var(--border);border-radius:8px;padding:6px 8px;color:var(--text-primary);font-weight:600;font-size:15px;transition:all .2s ease;-moz-appearance:textfield}
        .staffing-input::-webkit-outer-spin-button,.staffing-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
        .staffing-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(102, 126, 234, 0.1)}
        .staffing-input:hover{border-color:var(--accent)}
        .report-input{width:100%;background:transparent;border:1px solid transparent;border-radius:6px;padding:4px;text-align:center;color:var(--text-primary);font-weight:500;font-size:14px;transition:all .2s ease}
        .report-input:focus{outline:none;background:var(--surface-secondary);border-color:var(--accent)}
        .staffing-input:disabled, .report-input:disabled { background: rgba(128,128,128,0.1); cursor: not-allowed; color: var(--text-secondary); }
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes subtle-glow{0%,100%{filter:brightness(1.1) drop-shadow(0 0 8px rgba(102, 126, 234, 0.2))}50%{filter:brightness(1.2) drop-shadow(0 0 12px rgba(102, 126, 234, 0.3))}}
        @keyframes ethereal-glow{0%,80%{opacity:0;transform:scale(.8)}85%{opacity:.6;transform:scale(1.1)}95%{opacity:.3;transform:scale(1.3)}100%{opacity:0;transform:scale(1.5)}}
        @keyframes smooth-gradient-flow{0%,100%{background-position:0% 50%}25%{background-position:100% 50%}50%{background-position:50% 100%}75%{background-position:100% 0%}}
        @keyframes rocket-thruster{0%,100%{transform:translateY(0) rotate(-5deg);filter:drop-shadow(0 0 8px rgba(255, 215, 0, .6))}25%{transform:translateY(-1px) rotate(0);filter:drop-shadow(0 0 10px rgba(255, 215, 0, .7))}75%{transform:translateY(-.5px) rotate(2deg);filter:drop-shadow(0 0 6px rgba(255, 215, 0, .5))}}
        @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:.3}}
        @keyframes urgent-pulse{0%,100%{transform:scale(1);box-shadow:var(--shadow), 0 0 0 0 rgba(239, 68, 68, .4)}50%{transform:scale(1.02);box-shadow:var(--shadow), 0 0 0 4px rgba(239, 68, 68, .1)}}
        @keyframes rise-animation{from{transform:rotate(-90deg) scale(.8);opacity:0}to{transform:rotate(0) scale(1);opacity:1}}
        @keyframes set-animation{from{transform:rotate(0) scale(1);opacity:1}to{transform:rotate(90deg) scale(.8);opacity:0}}
        @keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
        @keyframes rocketPulse{0%,100%{transform:scale(1) rotate(-5deg)}50%{transform:scale(1.15) rotate(0)}}
        @keyframes gradientFlow{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
        @media (max-width: 1200px){.welcome-message > div:nth-of-type(2){flex-direction:column;align-items:center}}
        @media (max-width: 768px){.tab-navigation{padding:12px 20px}.tab-list{gap:24px}.tab-item{font-size:13px}.main-content{margin-top:160px}.header-top{padding:16px 20px}.header-title{font-size:18px}.date-display{background:none;border:none;padding:0;color:var(--text-secondary);box-shadow:none;font-size:12px;margin-left:8px;vertical-align:baseline}}
        @media (max-width: 480px){.tab-list{gap:20px}.tab-item{font-size:12px}}
    </style>
</head>
<body>
    <header class="fixed-header">
        <div class="header-top">
            <div class="header-title">
                <span class="rocket">🚀</span>
                <span class="title-text">GWJ2 OB 인원 관리 시트 #PDA 일지</span>
            </div>
            <div class="header-controls">
                <div id="user-status"></div> <div class="clock-display" id="currentClock">
                    <span class="clock-emoji">⏰</span>
                    <div class="time-segment">
                        <div class="time-unit"><div class="digit-box" id="hour1">0</div><div class="digit-box" id="hour2">0</div></div><span class="time-separator">:</span>
                        <div class="time-unit"><div class="digit-box" id="minute1">0</div><div class="digit-box" id="minute2">0</div></div><span class="time-separator">:</span>
                        <div class="time-unit"><div class="digit-box" id="second1">0</div><div class="digit-box" id="second2">0</div></div>
                    </div>
                </div>
                <button class="dark-light-toggle" aria-label="다크모드 토글">
                    <div class="icon30 sun"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fbbf24"><path d="M480-280q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM200-440H40v-80h160v80Zm720 0H760v-80h160v80ZM440-760v-160h80v160h-80Zm0 720v-160h80v160h-80ZM256-650l-101-97 57-59 96 100-52 56Zm492 496-97-101 53-55 101 97-57 59Zm-98-550 97-101 59 57-100 96-56-52ZM154-212l101-97 55 53-97 101-59-57Z"/></svg></div>
                    <div class="icon30 moon"><svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#fbbf24"><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Z"/></svg></div>
                </button>
            </div>
        </div>
        
        <nav class="tab-navigation">
            <div class="tab-list">
                <div class="tab-item active" data-tab="home">HOME</div>
                <div class="tab-item" data-tab="data">DATA</div>
                <div class="tab-item" data-tab="flow">FLOW</div>
                <div class="tab-item" data-tab="pack">PACK</div>
                <div class="tab-item" data-tab="pick">PICK</div>
                <div class="tab-item" data-tab="share">공유</div>
                <div class="tab-item" data-tab="rtpb">RTPB DATA</div>
                <div class="tab-item" data-tab="raw">RAW</div>
                <div class="tab-item" data-tab="duplicate">중복값</div>
                <div class="tab-item" data-tab="extension">연장 조사</div>
            </div>
        </nav>
    </header>

    <main class="main-content">
	<div class="content-area" id="contentArea">
        </div>
    </main>

    <script type="module">
        // Firebase SDK 가져오기
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, OAuthProvider, signInWithRedirect, getRedirectResult, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyDhYh-C1Zsv7PjRq0kHBNDUf8JMcxTV_l4",
            authDomain: "gwj2swingsheet.firebaseapp.com",
            projectId: "gwj2swingsheet",
            storageBucket: "gwj2swingsheet.appspot.com",
            messagingSenderId: "336629205001",
            appId: "1:336629205001:web:480a6bbb643ceff98c10d8",
            measurementId: "G-L5P3HWMB41"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const docRef = doc(db, "reports", "today");

        let unsubscribe = null; // Firestore 리스너 구독 해제 함수
        let isUpdatingFromFirestore = false;

        // Microsoft 로그인 핸들러
        function handleLogin() {
            const provider = new OAuthProvider('microsoft.com');
            signInWithRedirect(auth, provider);
        }

        // 페이지 로드 시 리디렉션 결과 처리
        getRedirectResult(auth)
            .catch((error) => {
                console.error("로그인 리디렉션 결과 처리 실패:", error);
            });

        // 인증 상태 변경 리스너
        onAuthStateChanged(auth, (user) => {
            const userStatusDiv = document.getElementById('user-status');
            const allInputs = document.querySelectorAll('.staffing-input, .report-input');

            if (user && !user.isAnonymous) { // 로그인된 사용자
                if (userStatusDiv) {
                    userStatusDiv.innerHTML = `<span>${user.displayName || user.email}</span> <button id="logout-btn">로그아웃</button>`;
                    const logoutBtn = document.getElementById('logout-btn');
                    if (logoutBtn) {
                        logoutBtn.addEventListener('click', () => signOut(auth));
                    }
                }
                allInputs.forEach(input => input.disabled = false);
                
                if (unsubscribe) unsubscribe();
                unsubscribe = onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        updateUIFromData(doc.data());
                    } else {
                        setDoc(docRef, getInitialData());
                    }
                }, (error) => {
                    console.error("Firestore 데이터 수신 오류:", error);
                    alert("데이터를 불러오는 데 실패했습니다. Firestore 보안 규칙을 확인해주세요.");
                });

            } else { // 로그아웃된 사용자
                if (userStatusDiv) {
                    userStatusDiv.innerHTML = `<button id="login-btn">Microsoft 계정으로 로그인</button>`;
                    const loginBtn = document.getElementById('login-btn');
                    if(loginBtn) {
                        loginBtn.addEventListener('click', handleLogin);
                    }
                }
                allInputs.forEach(input => input.disabled = true);
                
                if (unsubscribe) {
                    unsubscribe();
                    unsubscribe = null;
                }
            }
        });
        
        const tabContents = {
			home: { title: 'HOME', content: '' },
            data: { title: 'DATA 관리', content: '기본 데이터 관리 및 조회 기능을 제공합니다.' },
            flow: { title: 'FLOW 관리', content: '워크플로우 및 프로세스 관리를 위한 도구입니다.' },
            pack: { title: 'PACK 관리', content: '패키지 및 묶음 데이터 관리 기능입니다.' },
            pick: { title: 'PICK 관리', content: '선별 및 추출 작업을 위한 도구입니다.' },
            share: { title: '공유 관리', content: '데이터 공유 및 협업 기능을 제공합니다.' },
            rtpb: { title: 'RTPB DATA', content: '실시간 RTPB 데이터 분석 및 모니터링 기능입니다.' },
            raw: { title: 'RAW 데이터', content: '원본 데이터 조회 및 처리 기능을 제공합니다.' },
            duplicate: { title: '중복값 검사', content: '데이터 중복 검사 및 정리 도구입니다.' },
            extension: { title: '연장 조사', content: '추가 조사 및 연장 관련 업무 관리 기능입니다.' }
        };

        function switchTab(tabId) {
            const contentArea = document.getElementById('contentArea');
            if (!contentArea) return;
            
            document.querySelectorAll('.tab-item').forEach(tab => tab.classList.remove('active'));
            const selectedTab = document.querySelector(`[data-tab="${tabId}"]`);
            if (selectedTab) selectedTab.classList.add('active');
            
            if (tabId === 'home') {
                contentArea.innerHTML = `
                    <div class="welcome-message">
                        <div class="welcome-title" style="font-size: 48px; font-weight: 900; margin-bottom: 12px; line-height: 1.2;">
                            <span style="display: inline-block; animation: rocketPulse 2s ease-in-out infinite;">🚀</span> 
                            <span class="welcome-title-gradient">GWJ2 OB 인원 관리 시스템</span>
                        </div>
                        <div class="welcome-subtitle" style="font-size: 22px; font-weight: 600; color: var(--text-secondary); margin-bottom: 24px;"># PDA 일지</div>
                        <div class="welcome-line" style="width: 300px; height: 3px; background: linear-gradient(90deg, transparent, var(--accent), transparent); margin: 0 auto 24px;"></div>
                        <div class="welcome-version" style="font-size: 14px; color: var(--text-tertiary); font-weight: 500;">Ver 1.0</div>
                        
                        <div style="margin-top: 40px; display: flex; justify-content: center; align-items: stretch; gap: 24px; flex-wrap: wrap;">
                            <div style="flex: 1; max-width: 580px; min-width: 500px;">
                                <div id="staffing-box" style="background: var(--surface-primary); backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: 16px; padding: 24px; box-shadow: var(--shadow-lg); height: 100%;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 14px; border-bottom: 2px solid var(--border);">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <h3 style="font-size: 20px; font-weight: 800; color: var(--text-primary); margin: 0; letter-spacing: -0.5px;">📊 인원 현황</h3>
                                            <button id="capture-staffing-btn" class="capture-btn">📸</button>
                                        </div>
                                        <div style="display: flex; gap: 10px;">
                                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 8px 18px; border-radius: 10px; box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);">
                                                <div style="font-size: 9px; color: rgba(255,255,255,0.8); font-weight: 600; margin-bottom: 1px; letter-spacing: 0.3px;">채용률</div>
                                                <div style="color: white; font-weight: 900; font-size: 24px; line-height: 1; letter-spacing: -1px;"><span id="hiring-rate">-</span><span style="font-size: 16px;">%</span></div>
                                            </div>
                                            <div style="background: linear-gradient(135deg, #38bdf8 0%, #3b82f6 100%); padding: 0 18px; border-radius: 10px; box-shadow: 0 3px 10px rgba(59, 130, 246, 0.3); display: flex; align-items: center; justify-content: center;">
                                                <div style="color: white; font-weight: 900; font-size: 20px; letter-spacing: -0.5px;">SWING</div>
                                            </div>
                                        </div>
                                    </div>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead><tr style="border-bottom: 2px solid var(--border);"><th style="padding: 8px 0; text-align: center; color: var(--text-tertiary); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; width: 34%;">구분</th><th style="padding: 8px 0; text-align: center; color: var(--text-tertiary); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; width: 22%;">Plan</th><th style="padding: 8px 0; text-align: center; color: var(--text-tertiary); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; width: 22%;">Actual</th><th style="padding: 8px 0; text-align: center; color: var(--text-tertiary); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; width: 22%;">Gap</th></tr></thead>
                                        <tbody>
                                            <tr style="border-bottom: 1px solid var(--border);"><td colspan="4" style="padding: 10px 0; font-weight: 800; font-size: 15px; color: var(--text-primary); background: var(--surface-secondary); text-align: center;">상용직</td></tr>
                                            <tr style="border-bottom: 1px solid rgba(148, 163, 184, 0.08);"><td style="padding: 8px 0; color: var(--text-primary); font-weight: 500; font-size: 14px; text-align: center;">T/C</td><td style="padding: 8px 0; text-align: center;"><input type="number" id="perm-tc-plan" class="staffing-input"></td><td style="padding: 8px 0; text-align: center;"><input type="number" id="perm-tc-actual" class="staffing-input"></td><td style="padding: 8px 0; text-align: center; font-weight: 700; font-size: 15px;" id="perm-tc-gap"></td></tr>
                                            <tr style="border-bottom: 1px solid rgba(148, 163, 184, 0.08);"><td style="padding: 8px 0; color: var(--text-primary); font-weight: 500; font-size: 14px; text-align: center;">Perm</td><td style="padding: 8px 0; text-align: center;"><input type="number" id="perm-perm-plan" class="staffing-input"></td><td style="padding: 8px 0; text-align: center;"><input type="number" id="perm-perm-actual" class="staffing-input"></td><td style="padding: 8px 0; text-align: center; font-weight: 700; font-size: 15px;" id="perm-perm-gap"></td></tr>
                                            <tr style="background: var(--surface-secondary); border-bottom: 2px solid var(--border);"><td style="padding: 9px 0; font-weight: 700; color: var(--text-primary); font-size: 14px; text-align: center;">소계</td><td style="padding: 9px 0; text-align: center; font-weight: 700; font-size: 16px; color: var(--text-primary);" id="perm-total-plan"></td><td style="padding: 9px 0; text-align: center; font-weight: 700; font-size: 16px; color: var(--text-primary);" id="perm-total-actual"></td><td style="padding: 9px 0; text-align: center; font-weight: 700; font-size: 16px;" id="perm-total-gap"></td></tr>
                                            <tr style="border-bottom: 1px solid var(--border);"><td colspan="4" style="padding: 10px 0; font-weight: 800; font-size: 15px; color: var(--text-primary); background: var(--surface-secondary); text-align: center;">임시직</td></tr>
                                            <tr style="border-bottom: 1px solid rgba(148, 163, 184, 0.08);"><td style="padding: 8px 0; color: var(--text-primary); font-weight: 500; font-size: 14px; text-align: center;">Temp</td><td style="padding: 8px 0; text-align: center;"><input type="number" id="temp-temp-plan" class="staffing-input"></td><td style="padding: 8px 0; text-align: center;"><input type="number" id="temp-temp-actual" class="staffing-input"></td><td style="padding: 8px 0; text-align: center; font-weight: 700; font-size: 15px;" id="temp-temp-gap"></td></tr>
                                            <tr style="border-bottom: 1px solid rgba(148, 163, 184, 0.08);"><td style="padding: 8px 0; color: var(--text-primary); font-weight: 500; font-size: 14px; text-align: center;">Newbie</td><td style="padding: 8px 0; text-align: center;"><input type="number" id="temp-newbie-plan" class="staffing-input"></td><td style="padding: 8px 0; text-align: center;"><input type="number" id="temp-newbie-actual" class="staffing-input"></td><td style="padding: 8px 0; text-align: center; font-weight: 700; font-size: 15px;" id="temp-newbie-gap"></td></tr>
                                            <tr style="background: var(--surface-secondary); border-bottom: 2px solid var(--border);"><td style="padding: 9px 0; font-weight: 700; color: var(--text-primary); font-size: 14px; text-align: center;">소계</td><td style="padding: 9px 0; text-align: center; font-weight: 700; font-size: 16px; color: var(--text-primary);" id="temp-total-plan"></td><td style="padding: 9px 0; text-align: center; font-weight: 700; font-size: 16px; color: var(--text-primary);" id="temp-total-actual"></td><td style="padding: 9px 0; text-align: center; font-weight: 700; font-size: 16px;" id="temp-total-gap"></td></tr>
                                            <tr style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);"><td style="padding: 11px 0; font-weight: 800; font-size: 15px; color: var(--text-primary); text-align: center;">Total</td><td style="padding: 11px 0; text-align: center; font-weight: 800; font-size: 18px; color: var(--text-primary);" id="grand-total-plan"></td><td style="padding: 11px 0; text-align: center; font-weight: 800; font-size: 18px; color: var(--text-primary);" id="grand-total-actual"></td><td style="padding: 11px 0; text-align: center; font-weight: 800; font-size: 18px;" id="grand-total-gap"></td></tr>
                                        </tbody>
                                    </table>
                                    <div style="margin-top: 24px; display: flex; justify-content: center; gap: 12px;"><button id="reset-btn" style="background: #f87171; color: white; border: none; padding: 10px 20px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: background 0.2s ease;">값 초기화</button></div>
                                </div>
                            </div>
                            <div style="flex: 1; max-width: 580px; min-width: 500px;">
                                <div id="report-box" style="background: var(--surface-primary); backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: 16px; padding: 24px; box-shadow: var(--shadow-lg); height: 100%;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 14px; border-bottom: 2px solid var(--border);">
                                        <h3 style="font-size: 20px; font-weight: 800; color: var(--text-primary); margin: 0; letter-spacing: -0.5px;">▣ OB Employees Report</h3>
                                        <button id="capture-report-btn" class="capture-btn">📸</button>
                                    </div>
                                    <table id="manager-report-table" style="width: 100%; font-size: 14px; border-collapse: collapse;">
                                        <tbody>
                                            <tr><td style="width: 80px; font-weight: 600; padding: 2px 4px; text-align: center;">OM/AM</td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td></tr>
                                            <tr><td style="font-weight: 600; padding: 2px 4px; text-align: center;">T/C</td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td></tr>
                                            <tr><td></td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td></tr>
                                            <tr><td></td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td></tr>
                                            <tr><td></td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td></tr>
                                            <tr><td></td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td></tr>
                                            <tr><td></td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td><td style="padding: 2px;"><input type="text" class="report-input"></td></tr>
                                            <tr style="border-top: 1px solid var(--border);"><td style="font-weight: 600; padding: 6px 4px; text-align: center;">Total</td><td id="report-manager-total" style="font-weight: 700; text-align: center;" colspan="3">0</td></tr>
                                        </tbody>
                                    </table>
                                    <h3 style="font-size: 20px; font-weight: 800; color: var(--text-primary); margin: 20px 0 4px 0; letter-spacing: -0.5px; text-align: left; padding-top: 20px; padding-bottom: 14px; border-top: 2px solid var(--border);">📊 실시간 인원 현황</h3>
                                    <table id="live-status-table" style="width: 100%; margin-top: 10px; font-size: 14px; border-collapse: collapse;">
                                        <thead><tr style="border-bottom: 2px solid var(--border);"><th style="text-align: center; color: var(--text-tertiary); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; width: 50%;">구분</th><th style="text-align: center; color: var(--text-tertiary); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; width: 25%;">인원</th><th style="text-align: center; color: var(--text-tertiary); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; width: 25%;">비고</th></tr></thead>
                                        <tbody>
                                            <tr><td style="font-weight: 500; padding: 8px 0; text-align: center;">Team Captain</td><td id="report-tc-actual" style="text-align: center; font-weight: 600;">- 명</td><td style="text-align: center; padding: 2px;"><input type="text" class="report-input"></td></tr>
                                            <tr><td style="font-weight: 500; padding: 8px 0; text-align: center;">계약직</td><td id="report-perm-actual" style="text-align: center; font-weight: 600;">- 명</td><td style="text-align: center; padding: 2px;"><input type="text" class="report-input"></td></tr>
                                            <tr><td style="font-weight: 500; padding: 8px 0; text-align: center;">단기직</td><td id="report-temp-actual" style="text-align: center; font-weight: 600;">- 명</td><td style="text-align: center; padding: 2px;"><input type="text" class="report-input"></td></tr>
                                            <tr style="border-top: 1px solid var(--border);"><td style="font-weight: 700; padding: 8px 0; text-align: center;">Total</td><td id="report-total-actual" style="text-align: center; font-weight: 700;">- 명</td><td style="text-align: center;">-</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                 setTimeout(() => {
                    initializeHomeTabListeners();
                }, 0);
                return;
            }
            
            const content = tabContents[tabId];
            contentArea.innerHTML = `
                <div class="tab-content" style="animation: fadeIn 0.3s ease-out;">
                    <h2 style="color: var(--text-primary); font-size: 28px; font-weight: 700; margin-bottom: 16px;">${content.title}</h2>
                    <p style="color: var(--text-secondary); font-size: 16px; line-height: 1.6;">${content.content}</p>
                    <div style="margin-top: 32px; padding: 24px; background: var(--surface-secondary); border-radius: 16px; border: 1px solid var(--border);">
                        <p style="color: var(--text-secondary); font-size: 14px; text-align: center; opacity: 0.8;">
                            ${content.title} 기능이 곧 업데이트됩니다. ✨
                        </p>
                    </div>
                </div>
            `;
        }

        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('hour1').textContent = hours[0];
            document.getElementById('hour2').textContent = hours[1];
            document.getElementById('minute1').textContent = minutes[0];
            document.getElementById('minute2').textContent = minutes[1];
            document.getElementById('second1').textContent = seconds[0];
            document.getElementById('second2').textContent = seconds[1];
            checkUrgentDeadline(now);
        }

        function checkUrgentDeadline(currentTime) {
            const clockElement = document.getElementById('currentClock');
            let isUrgent = false;
            const deadlines = [ { hour: 11, minute: 10 }, { hour: 11, minute: 30 }, { hour: 17, minute: 30 }, { hour: 22, minute: 0 }, { hour: 1, minute: 15 }, { hour: 3, minute: 30 }, { hour: 4, minute: 30 } ];
            deadlines.forEach(deadline => {
                const deadlineTime = new Date(currentTime);
                deadlineTime.setHours(deadline.hour, deadline.minute, 0, 0);
                const urgentTime = new Date(deadlineTime);
                urgentTime.setHours(urgentTime.getHours() - 1);
                if (currentTime >= urgentTime && currentTime <= deadlineTime) {
                    isUrgent = true;
                }
            });
            if (isUrgent) {
                clockElement.classList.add('clock-urgent');
            } else {
                clockElement.classList.remove('clock-urgent');
            }
        }
        
        function displayCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const date = String(now.getDate()).padStart(2, '0');
            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
            const day = dayNames[now.getDay()];
            const formattedDate = `${year}년 ${month}월 ${date}일 (${day})`;
            const dateElement = document.createElement('span');
            dateElement.className = 'date-display';
            dateElement.textContent = formattedDate;
            const titleContainer = document.querySelector('.header-title');
            if (titleContainer && !document.querySelector('.date-display')) {
                titleContainer.appendChild(dateElement);
            }
        }
        
        function captureElementAsImage(elementId, friendlyName) {
            const element = document.getElementById(elementId);
            if (!element) {
                alert('캡처할 대상을 찾을 수 없습니다.');
                return;
            }
            const currentTheme = document.documentElement.getAttribute("color-theme");
            const bgColor = (currentTheme === 'dark') ? '#1e293b' : '#f8fafc';

            html2canvas(element, { 
                useCORS: true, 
                backgroundColor: bgColor,
                scale: 2,
                onclone: (document) => {
                    document.querySelectorAll('input').forEach(input => {
                        const text = document.createElement('div');
                        text.style.cssText = input.style.cssText;
                        Object.assign(text.style, {
                            width: input.style.width || `${input.offsetWidth}px`,
                            height: input.style.height || `${input.offsetHeight}px`,
                            display: 'flex', alignItems: 'center', justifyContent: 'center',
                            border: 'none', background: 'transparent'
                        });
                        text.innerText = input.value;
                        input.parentNode.replaceChild(text, input);
                    });
                }
            }).then(canvas => {
                canvas.toBlob(blob => {
                    if (navigator.clipboard && navigator.clipboard.write) {
                        navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]).then(() => {
                            alert(`'${friendlyName}' 박스가 이미지(PNG)로 복사되었습니다!`);
                        }).catch(err => {
                            console.error('클립보드 복사 실패:', err);
                            alert('클립보드 복사에 실패했습니다. 브라우저 권한을 확인해주세요.');
                        });
                    } else {
                        alert('이 브라우저에서는 클립보드 복사 기능을 지원하지 않습니다.');
                    }
                }, 'image/png');
            });
        }
        
        function initializeHomeTabListeners() {
            document.querySelectorAll('.staffing-input, .report-input').forEach(input => {
                input.addEventListener('input', saveDataToFirestore);
            });
            document.getElementById('reset-btn')?.addEventListener('click', () => {
                if (confirm('정말로 모든 값을 0으로 초기화하시겠습니까?')) {
                    setDoc(docRef, getInitialData());
                    alert('모든 값이 0으로 초기화되었습니다.');
                }
            });
            document.getElementById('capture-staffing-btn')?.addEventListener('click', () => captureElementAsImage('staffing-box', '인원 현황'));
            document.getElementById('capture-report-btn')?.addEventListener('click', () => captureElementAsImage('report-box', 'OB Report'));
            onAuthStateChanged(auth, user => {
                const allInputs = document.querySelectorAll('.staffing-input, .report-input');
                allInputs.forEach(input => input.disabled = !user || user.isAnonymous);
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            const savedTheme = localStorage.getItem("color-theme") || "light";
            document.documentElement.setAttribute("color-theme", savedTheme);
            
            displayCurrentDate(); 
            updateClock();
            setInterval(updateClock, 1000);

            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            switchTab('home');
        });

        const toggleButton = document.querySelector('.dark-light-toggle');
        toggleButton.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute("color-theme");
            const newTheme = currentTheme === "light" ? "dark" : "light";
            document.documentElement.setAttribute("color-theme", newTheme);
            localStorage.setItem("color-theme", newTheme);
        });
        
        function getInitialData() {
            return {
                staffing: { 'perm-tc-plan': 0, 'perm-tc-actual': 0, 'perm-perm-plan': 0, 'perm-perm-actual': 0, 'temp-temp-plan': 0, 'temp-temp-actual': 0, 'temp-newbie-plan': 0, 'temp-newbie-actual': 0 },
                report: { managers: Array(24).fill('-'), remarks: Array(3).fill('-') }
            };
        }
        
        let debounceTimer;
        function saveDataToFirestore() {
            if (isUpdatingFromFirestore) return;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const staffingData = {};
                document.querySelectorAll('.staffing-input').forEach(input => {
                    staffingData[input.id] = parseInt(input.value) || 0;
                });
                const managerInputs = document.querySelectorAll('#manager-report-table .report-input');
                const managerData = Array.from(managerInputs).map(input => input.value);
                const remarkInputs = document.querySelectorAll('#live-status-table .report-input');
                const remarkData = Array.from(remarkInputs).map(input => input.value);

                const dataToSave = {
                    staffing: staffingData,
                    report: { managers: managerData, remarks: remarkData }
                };
                setDoc(docRef, dataToSave, { merge: true });
            }, 500);
        }

        function updateUIFromData(data) {
            isUpdatingFromFirestore = true;
            try {
                if (data.staffing) {
                    for (const id in data.staffing) {
                        const input = document.getElementById(id);
                        if (input && input.value !== String(data.staffing[id])) input.value = data.staffing[id];
                    }
                }
                if (data.report && data.report.managers) {
                    const managerInputs = document.querySelectorAll('#manager-report-table .report-input');
                    managerInputs.forEach((input, index) => {
                        const value = data.report.managers[index] || '';
                        if (input.value !== value) input.value = value;
                    });
                }
                if (data.report && data.report.remarks) {
                    const remarkInputs = document.querySelectorAll('#live-status-table .report-input');
                    remarkInputs.forEach((input, index) => {
                        const value = data.report.remarks[index] || '';
                        if (input.value !== value) input.value = value;
                    });
                }
            } finally {
                calculateAll();
                isUpdatingFromFirestore = false;
            }
        }
		
        function updateReportTotal() {
            const managerReportTable = document.getElementById('manager-report-table');
            if (!managerReportTable) return;
            const nameInputs = managerReportTable.querySelectorAll('.report-input');
            let count = 0;
            nameInputs.forEach(input => {
                if (input.value.trim() !== '' && input.value.trim() !== '-') {
                    count++;
                }
            });
            const reportTotalCell = document.getElementById('report-manager-total');
            if(reportTotalCell) reportTotalCell.textContent = count;
        }

        function calculateAll() {
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')} (${['일','월','화','수','목','금','토'][now.getDay()]})`;
                dateElement.textContent = dateStr;
            }
            
            const permTcPlan = parseInt(document.getElementById('perm-tc-plan')?.value) || 0;
            const permTcActual = parseInt(document.getElementById('perm-tc-actual')?.value) || 0;
            const permPermPlan = parseInt(document.getElementById('perm-perm-plan')?.value) || 0;
            const permPermActual = parseInt(document.getElementById('perm-perm-actual')?.value) || 0;
            const tempTempPlan = parseInt(document.getElementById('temp-temp-plan')?.value) || 0;
            const tempTempActual = parseInt(document.getElementById('temp-temp-actual')?.value) || 0;
            const tempNewbiePlan = parseInt(document.getElementById('temp-newbie-plan')?.value) || 0;
            const tempNewbieActual = parseInt(document.getElementById('temp-newbie-actual')?.value) || 0;
            
            const permTcGap = permTcActual - permTcPlan;
            const permPermGap = permPermActual - permPermPlan;
            const tempTempGap = tempTempActual - tempTempPlan;
            const tempNewbieGap = tempNewbieActual - tempNewbiePlan;
            
            const permTotalPlan = permTcPlan + permPermPlan;
            const permTotalActual = permTcActual + permPermActual;
            const permTotalGap = permTotalActual - permTotalPlan;
            
            const tempTotalPlan = tempTempPlan + tempNewbiePlan;
            const tempTotalActual = tempTempActual + tempNewbieActual;
            const tempTotalGap = tempTotalActual - tempTotalPlan;
            
            const grandTotalPlan = permTotalPlan + tempTotalPlan;
            const grandTotalActual = permTotalActual + tempTotalActual;
            const grandTotalGap = grandTotalActual - grandTotalPlan;
            
            const hiringRate = grandTotalPlan > 0 ? ((grandTotalActual / grandTotalPlan) * 100).toFixed(0) : 0;
            
            const setGapColor = (element, value) => {
                if (!element) return;
                if (value > 0) {
                    element.style.color = '#4ade80';
                    element.textContent = '+' + value;
                } else if (value < 0) {
                    element.style.color = '#f87171';
                    element.textContent = value;
                } else {
                    element.style.color = 'var(--text-primary)';
                    element.textContent = '0';
                }
            };
            
            setGapColor(document.getElementById('perm-tc-gap'), permTcGap);
            setGapColor(document.getElementById('perm-perm-gap'), permPermGap);
            setGapColor(document.getElementById('temp-temp-gap'), tempTempGap);
            setGapColor(document.getElementById('temp-newbie-gap'), tempNewbieGap);
            
            if (document.getElementById('perm-total-plan')) document.getElementById('perm-total-plan').textContent = permTotalPlan;
            if (document.getElementById('perm-total-actual')) document.getElementById('perm-total-actual').textContent = permTotalActual;
            setGapColor(document.getElementById('perm-total-gap'), permTotalGap);
            
            if (document.getElementById('temp-total-plan')) document.getElementById('temp-total-plan').textContent = tempTotalPlan;
            if (document.getElementById('temp-total-actual')) document.getElementById('temp-total-actual').textContent = tempTotalActual;
            setGapColor(document.getElementById('temp-total-gap'), tempTotalGap);
            
            if (document.getElementById('grand-total-plan')) document.getElementById('grand-total-plan').textContent = grandTotalPlan;
            if (document.getElementById('grand-total-actual')) document.getElementById('grand-total-actual').textContent = grandTotalActual;
            setGapColor(document.getElementById('grand-total-gap'), grandTotalGap);
            
            const hiringRateElement = document.getElementById('hiring-rate');
            if (hiringRateElement) hiringRateElement.textContent = hiringRate;

            const reportTcActual = permTcActual;
            const reportPermActual = permPermActual;
            const reportTempActual = tempTempActual;
            const reportTotalActual = reportTcActual + reportPermActual + reportTempActual;

            if(document.getElementById('report-tc-actual')) document.getElementById('report-tc-actual').textContent = reportTcActual + ' 명';
            if(document.getElementById('report-perm-actual')) document.getElementById('report-perm-actual').textContent = reportPermActual + ' 명';
            if(document.getElementById('report-temp-actual')) document.getElementById('report-temp-actual').textContent = reportTempActual + ' 명';
            if(document.getElementById('report-total-actual')) document.getElementById('report-total-actual').textContent = reportTotalActual + ' 명';

            updateReportTotal();
        }
    </script>
</body>
</html>